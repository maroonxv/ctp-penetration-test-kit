<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>CTP ç©¿é€æµ‹è¯•æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        /* æ—¥å¿—åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        #log-container {
            height: 85vh;
            overflow-y: auto;
            background-color: #1e1e1e;
            border: 1px solid #333;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            border-radius: 5px;
        }
        .log-line { margin: 2px 0; border-bottom: 1px dashed #2b2b2b; }
        .sidebar { height: 100vh; border-right: 1px solid #333; padding: 20px; overflow-y: auto; }
        .btn-group-custom { margin-bottom: 15px; width: 100%; }
        .btn-group-custom .btn { width: 100%; text-align: left; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- å·¦ä¾§æ§åˆ¶æ  -->
            <div class="col-md-3 sidebar bg-dark">
                <h4 class="mb-4 text-primary">ğŸ›¡ï¸ CTP æµ‹è¯•æ§åˆ¶å°</h4>
                
                <!-- ç¯å¢ƒä¿¡æ¯ -->
                <div class="card mb-4 bg-secondary bg-opacity-10">
                    <div class="card-body py-2">
                        <small class="text-muted">å½“å‰ç¯å¢ƒ</small>
                        <div class="fw-bold text-info">{{ env.BROKER }} / {{ env.USER }}</div>
                        <div class="text-truncate" style="font-size: 12px;">{{ env.SERVER }}</div>
                    </div>
                </div>

                <!-- æµ‹è¯•æ§åˆ¶æŒ‰é’® -->
                <div class="accordion" id="testAccordion">
                    <!-- 2.1 åŸºç¡€ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#c21">2.1 æ¥å£é€‚åº”æ€§</button></h2>
                        <div id="c21" class="accordion-collapse collapse show" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.1.1')" class="btn btn-outline-light btn-sm w-100 mb-2">2.1.1 è¿é€šæ€§æµ‹è¯•</button>
                                <button onclick="runTest('2.1.2')" class="btn btn-outline-light btn-sm w-100">2.1.2 åŸºç¡€äº¤æ˜“(å¼€/å¹³/æ’¤)</button>
                            </div>
                        </div>
                    </div>

                    <!-- 2.2 å¼‚å¸¸ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c22">2.2 å¼‚å¸¸ç›‘æµ‹</button></h2>
                        <div id="c22" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.2.1')" class="btn btn-outline-warning btn-sm w-100 mb-2">2.2.1 è¿æ¥çŠ¶æ€ç›‘æµ‹</button>
                                <button onclick="runTest('2.2.2')" class="btn btn-outline-warning btn-sm w-100 mb-2">2.2.2 æŠ¥æ’¤å•ç¬”æ•°ç›‘æµ‹</button>
                                <button onclick="runTest('2.2.3')" class="btn btn-outline-warning btn-sm w-100">2.2.3 é‡å¤æŠ¥å•ç›‘æµ‹</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.3 é˜ˆå€¼ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c23">2.3 é˜ˆå€¼ç®¡ç†</button></h2>
                        <div id="c23" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.3.1')" class="btn btn-outline-info btn-sm w-100 mb-2">2.3.1 é˜ˆå€¼è®¾ç½®åŠé¢„è­¦</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.4 é”™è¯¯ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c24">2.4 é”™è¯¯é˜²èŒƒ</button></h2>
                        <div id="c24" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.4.1')" class="btn btn-outline-danger btn-sm w-100 mb-2">2.4.1 äº¤æ˜“æŒ‡ä»¤æ£€æŸ¥</button>
                                <button onclick="runTest('2.4.2')" class="btn btn-outline-danger btn-sm w-100">2.4.2 é”™è¯¯æç¤ºåŠŸèƒ½</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.5 åº”æ€¥ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c25">2.5 åº”æ€¥å¤„ç†</button></h2>
                        <div id="c25" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.5.1')" class="btn btn-danger btn-sm w-100 mb-2">2.5.1 æš‚åœäº¤æ˜“</button>
                                <button onclick="runTest('2.5.2')" class="btn btn-outline-danger btn-sm w-100 mb-2">2.5.2 æ‰¹é‡æ’¤å•</button>
                                <hr>
                                <button onclick="resetSystem()" class="btn btn-success btn-sm w-100">â™»ï¸ é‡ç½®/æ¢å¤äº¤æ˜“æƒé™</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.6 æ—¥å¿— -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c26">2.6 æ—¥å¿—è®°å½•</button></h2>
                        <div id="c26" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.6.1')" class="btn btn-outline-secondary btn-sm w-100">2.6.1 æ—¥å¿—è®°å½•åŠŸèƒ½</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ—¥å¿—åŒº -->
            <div class="col-md-9 p-0">
                <div id="log-container">
                    <div class="text-muted p-2">ç­‰å¾…è¿æ¥ SocketIO...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const logContainer = document.getElementById('log-container');

        // æ—¥å¿—æ¥æ”¶é€»è¾‘
        socket.on('new_log', function(data) {
            const div = document.createElement('div');
            div.className = 'log-line';
            div.style.color = data.color;
            div.textContent = data.message;
            
            logContainer.appendChild(div);
            
            // è‡ªåŠ¨æ»šåŠ¨
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶æœ€å¤§è¡Œæ•° 1000
            if (logContainer.children.length > 1000) {
                logContainer.removeChild(logContainer.firstChild);
            }
        });

        socket.on('connect', () => {
            logContainer.innerHTML = '<div class="text-success p-2">âœ… æœåŠ¡å™¨å·²è¿æ¥</div>';
        });

        // API è°ƒç”¨é€»è¾‘
        function runTest(caseId) {
            fetch(`/api/run/${caseId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.status !== 'success') alert(data.msg);
                });
        }

        function resetSystem() {
            fetch('/api/control/reset', { method: 'POST' })
                .then(res => res.json())
                .then(data => alert(data.msg));
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
