<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>CTP 穿透测试控制台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 左侧控制栏 -->
            <div class="col-md-3 sidebar">
                <h2 class="mb-4 ps-4">CTP 穿透测试</h4>
                
                <!-- 环境信息 -->
                <div class="card mb-4 mx-2">
                    <div class="card-body py-3">
                        <small class="text-secondary text-uppercase" style="letter-spacing: 1px;">当前环境</small>
                        <div class="fw-bold mt-1" style="color: #00ff88; font-size: 1.1em;">{{ env.CTP_NAME }}</div>
                        <div class="mt-1" style="font-size: 0.9em;">账户: {{ env.CTP_USERNAME }}</div>
                        <div class="mt-1" style="font-size: 0.9em;" title="{{ env.CTP_TD_SERVER }}">交易服务器: {{ env.CTP_TD_SERVER }}</div>
                        <div class="mt-1" style="font-size: 0.9em;" title="{{ env.CTP_MD_SERVER }}">行情服务器: {{ env.CTP_MD_SERVER }}</div>
                    </div>
                </div>

                <!-- 阈值设置已移动到弹窗 -->

                <div class="card mb-4 mx-2">
                    <div class="card-body py-3">
                        <small class="text-secondary text-uppercase" style="letter-spacing: 1px;">实时统计</small>
                        <div class="mt-2" style="font-size: 0.9em;">
                            <div class="d-flex justify-content-between"><span>报单笔数</span><span id="metric-order">-</span></div>
                            <div class="d-flex justify-content-between"><span>撤单笔数</span><span id="metric-cancel">-</span></div>
                            <div class="d-flex justify-content-between"><span>重复报单(选测)</span><span id="metric-repeat">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- 测试控制按钮 -->
                <div class="accordion" id="testAccordion">
                    <!-- 2.1 基础 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#c21">接口适应性</button></h2>
                        <div id="c21" class="accordion-collapse collapse show" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.1.1')" class="btn btn-outline-light btn-sm w-100 mb-2">连通性测试</button>
                                <button onclick="openTestConfigModal()" class="btn btn-outline-secondary btn-sm w-100 mb-2">设置测试参数</button>
                                <button onclick="runTest('2.1.2.1')" class="btn btn-outline-light btn-sm w-100 mb-2">开仓测试</button>
                                <button onclick="runTest('2.1.2.2')" class="btn btn-outline-light btn-sm w-100 mb-2">平仓测试</button>
                                <button onclick="runTest('2.1.2.3')" class="btn btn-outline-light btn-sm w-100">撤单测试</button>
                            </div>
                        </div>
                    </div>

                    <!-- 2.2 异常 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c22">异常监测</button></h2>
                        <div id="c22" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.2.1.1')" class="btn btn-outline-light btn-sm w-100 mb-2">连接状态监测</button>
                                <button onclick="runTest('2.2.1.2')" class="btn btn-outline-light btn-sm w-100 mb-2">断线模拟</button>
                                <button onclick="runTest('2.2.1.3')" class="btn btn-outline-light btn-sm w-100 mb-2">重连模拟</button>
                                <hr class="border-secondary opacity-25 my-3">
                                <button onclick="openOrderCancelMonitorConfigModal()" class="btn btn-outline-secondary btn-sm w-100 mb-2">设置报撤单监测阈值</button>
                                <button onclick="runTest('2.2.2.1')" class="btn btn-outline-light btn-sm w-100 mb-2">报单笔数监测</button>
                                <button onclick="runTest('2.2.2.2')" class="btn btn-outline-light btn-sm w-100 mb-2">撤单笔数监测</button>
                                <hr class="border-secondary opacity-25 my-3">
                                <button onclick="openRepeatMonitorConfigModal()" class="btn btn-outline-secondary btn-sm w-100 mb-2">设置重复报单监测阈值</button>
                                <button onclick="runTest('2.2.3.1')" class="btn btn-outline-light btn-sm w-100 mb-2">重复报单监测(开)</button>
                                <button onclick="runTest('2.2.3.2')" class="btn btn-outline-light btn-sm w-100 mb-2">重复报单监测(平)</button>
                                <button onclick="runTest('2.2.3.3')" class="btn btn-outline-light btn-sm w-100">重复报单监测(撤)</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.3 阈值 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c23">阈值管理</button></h2>
                        <div id="c23" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="openThresholdModal()" class="btn btn-outline-secondary btn-sm w-100 mb-2">设置阈值</button>
                                <button onclick="runTest('2.3.1.1')" class="btn btn-outline-light btn-sm w-100 mb-2">报单笔数预警</button>
                                <button onclick="runTest('2.3.1.3')" class="btn btn-outline-light btn-sm w-100 mb-2">撤单笔数预警</button>
                                <button onclick="runTest('2.3.1.5')" class="btn btn-outline-light btn-sm w-100">重复报单预警</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.4 错误 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c24">错误防范</button></h2>
                        <div id="c24" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.4.1.1')" class="btn btn-outline-light btn-sm w-100 mb-2">合约代码错误</button>
                                <button onclick="runTest('2.4.1.2')" class="btn btn-outline-light btn-sm w-100 mb-2">价格错误</button>
                                <button onclick="openVolumeLimitModal()" class="btn btn-outline-light btn-sm w-100 mb-2">数量超限</button>
                                <hr class="border-secondary opacity-25 my-3">
                                <button onclick="runTest('2.4.2.1')" class="btn btn-outline-light btn-sm w-100 mb-2">资金不足提示</button>
                                <button onclick="runTest('2.4.2.2')" class="btn btn-outline-light btn-sm w-100 mb-2">持仓不足提示</button>
                                <button onclick="runTest('2.4.2.3')" class="btn btn-outline-light btn-sm w-100">市场状态错误</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.5 应急 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c25">应急处理</button></h2>
                        <div id="c25" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.5.1.1')" class="btn btn-outline-light btn-sm w-100 mb-2">限制交易权限</button>
                                <button onclick="runTest('2.5.1.2')" class="btn btn-outline-light btn-sm w-100 mb-2">暂停策略执行</button>
                                <button onclick="runTest('2.5.1.3')" class="btn btn-danger btn-sm w-100 mb-2">强制账号退出</button>
                                <hr class="border-secondary opacity-25 my-3">
                                <button onclick="runTest('2.5.2.1')" class="btn btn-outline-light btn-sm w-100 mb-2">撤销部分成交</button>
                                <button onclick="runTest('2.5.2.2')" class="btn btn-outline-light btn-sm w-100 mb-2">批量撤销所有</button>
                                <hr class="border-secondary opacity-25 my-3">
                                <button onclick="resetSystem()" class="btn btn-success btn-sm w-100">重置 / 恢复交易权限</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2.6 日志 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c26">日志记录</button></h2>
                        <div id="c26" class="accordion-collapse collapse" data-bs-parent="#testAccordion">
                            <div class="accordion-body p-2">
                                <button onclick="runTest('2.6.1')" class="btn btn-outline-light btn-sm w-100">日志记录功能</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧日志区 -->
            <div class="col-md-9">
                <div id="log-container">
                    <div class="d-flex align-items-center justify-content-center h-100 text-secondary">
                        <small>Waiting for connection...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Threshold Settings Modal -->
    <div class="modal fade" id="thresholdModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">阈值设置及预警</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div style="font-size: 0.9em;">报单阈值</div>
                                <div class="text-secondary" style="font-size: 0.85em;">当前: <span id="current-thr-order">-</span></div>
                            </div>
                            <input id="thr-order" type="number" min="1" step="1" class="form-control form-control-sm mt-1" placeholder="例如 5">
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div style="font-size: 0.9em;">撤单阈值</div>
                                <div class="text-secondary" style="font-size: 0.85em;">当前: <span id="current-thr-cancel">-</span></div>
                            </div>
                            <input id="thr-cancel" type="number" min="1" step="1" class="form-control form-control-sm mt-1" placeholder="例如 3">
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div style="font-size: 0.9em;">重复报单阈值(选测)</div>
                                <div class="text-secondary" style="font-size: 0.85em;">当前: <span id="current-thr-repeat">-</span></div>
                            </div>
                            <div class="form-check form-switch mt-1">
                                <input class="form-check-input" type="checkbox" role="switch" id="thr-repeat-enabled" checked>
                                <label class="form-check-label" for="thr-repeat-enabled" style="font-size: 0.85em;">启用重复报单预警</label>
                            </div>
                            <input id="thr-repeat" type="number" min="1" step="1" class="form-control form-control-sm mt-1" placeholder="例如 2">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveThresholds()">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="volumeLimitModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">数量超限参数设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <label for="volerr-symbol" class="form-label" style="font-size: 0.9em;">发单品种 (test_symbol)</label>
                            <input id="volerr-symbol" type="text" class="form-control form-control-sm" placeholder="例如 IF2602">
                        </div>
                        <div class="col-12">
                            <label for="volerr-volume" class="form-label" style="font-size: 0.9em;">委托手数 (volume)</label>
                            <input id="volerr-volume" type="number" min="1" step="1" class="form-control form-control-sm" placeholder="例如 10000">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndRunVolumeLimit()">保存并运行测试</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Config Modal -->
    <div class="modal fade" id="testConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">基础交易参数设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <label for="conf-symbol" class="form-label" style="font-size: 0.9em;">测试合约代码 (test_symbol)</label>
                            <input id="conf-symbol" type="text" class="form-control form-control-sm" placeholder="例如 IF2602">
                        </div>
                        <div class="col-12">
                            <label for="conf-safe-price" class="form-label" style="font-size: 0.9em;">安全买入价 (safe_buy_price) - 平仓用</label>
                            <input id="conf-safe-price" type="number" step="0.2" class="form-control form-control-sm" placeholder="例如 4700.0">
                        </div>
                        <div class="col-12">
                            <label for="conf-deal-price" class="form-label" style="font-size: 0.9em;">成交买入价 (deal_buy_price) - 开仓用</label>
                            <input id="conf-deal-price" type="number" step="0.2" class="form-control form-control-sm" placeholder="例如 4800.0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndRunTestConfig()">保存并运行测试</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Repeat Monitor Config Modal -->
    <div class="modal fade" id="repeatMonitorConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">重复报单监测参数设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <label for="repeat-open-thr" class="form-label" style="font-size: 0.9em;">开仓监测阈值 (repeat_open_threshold)</label>
                            <input id="repeat-open-thr" type="number" min="1" step="1" class="form-control form-control-sm" placeholder="例如 2">
                        </div>
                        <div class="col-12">
                            <label for="repeat-close-thr" class="form-label" style="font-size: 0.9em;">平仓监测阈值 (repeat_close_threshold)</label>
                            <input id="repeat-close-thr" type="number" min="1" step="1" class="form-control form-control-sm" placeholder="例如 2">
                        </div>
                        <div class="col-12">
                            <label for="repeat-conf-symbol" class="form-label" style="font-size: 0.9em;">测试合约代码 (test_symbol)</label>
                            <input id="repeat-conf-symbol" type="text" class="form-control form-control-sm" placeholder="例如 IF2602">
                        </div>
                        <div class="col-12">
                            <label for="repeat-conf-safe-price" class="form-label" style="font-size: 0.9em;">安全买入价 (safe_buy_price) - 平仓用</label>
                            <input id="repeat-conf-safe-price" type="number" step="0.2" class="form-control form-control-sm" placeholder="例如 4700.0">
                        </div>
                        <div class="col-12">
                            <label for="repeat-conf-deal-price" class="form-label" style="font-size: 0.9em;">成交买入价 (deal_buy_price) - 开仓用</label>
                            <input id="repeat-conf-deal-price" type="number" step="0.2" class="form-control form-control-sm" placeholder="例如 4800.0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveRepeatMonitorConfig()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order/Cancel Monitor Config Modal -->
    <div class="modal fade" id="orderCancelMonitorConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">报撤单监测阈值设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-12">
                            <label for="order-monitor-thr" class="form-label" style="font-size: 0.9em;">报单监测阈值 (order_monitor_threshold)</label>
                            <input id="order-monitor-thr" type="number" min="1" step="1" class="form-control form-control-sm" placeholder="例如 5">
                        </div>
                        <div class="col-12">
                            <label for="cancel-monitor-thr" class="form-label" style="font-size: 0.9em;">撤单监测阈值 (cancel_monitor_threshold)</label>
                            <input id="cancel-monitor-thr" type="number" min="1" step="1" class="form-control form-control-sm" placeholder="例如 3">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrderCancelMonitorConfig()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
        <div id="toast-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        const logContainer = document.getElementById('log-container');
        const toastContainer = document.getElementById('toast-container');

        const thresholdInputs = {
            order: document.getElementById('thr-order'),
            cancel: document.getElementById('thr-cancel'),
            repeat: document.getElementById('thr-repeat'),
            repeatEnabled: document.getElementById('thr-repeat-enabled'),
        };

        const thresholdCurrent = {
            order: document.getElementById('current-thr-order'),
            cancel: document.getElementById('current-thr-cancel'),
            repeat: document.getElementById('current-thr-repeat'),
        };

        const metrics = {
            order: document.getElementById('metric-order'),
            cancel: document.getElementById('metric-cancel'),
            repeat: document.getElementById('metric-repeat'),
        };

        const testConfigInputs = {
            symbol: document.getElementById('conf-symbol'),
            safePrice: document.getElementById('conf-safe-price'),
            dealPrice: document.getElementById('conf-deal-price'),
        };

        const repeatMonitorConfigInputs = {
            openThreshold: document.getElementById('repeat-open-thr'),
            closeThreshold: document.getElementById('repeat-close-thr'),
            symbol: document.getElementById('repeat-conf-symbol'),
            safePrice: document.getElementById('repeat-conf-safe-price'),
            dealPrice: document.getElementById('repeat-conf-deal-price'),
        };

        const orderCancelMonitorConfigInputs = {
            orderThreshold: document.getElementById('order-monitor-thr'),
            cancelThreshold: document.getElementById('cancel-monitor-thr'),
        };

        const volumeLimitInputs = {
            symbol: document.getElementById('volerr-symbol'),
            volume: document.getElementById('volerr-volume'),
        };

        let thresholdModal;
        let volumeLimitModal;
        let testConfigModal;
        let repeatMonitorConfigModal;
        let orderCancelMonitorConfigModal;

        document.addEventListener('DOMContentLoaded', function() {
            const el = document.getElementById('thresholdModal');
            if (el) {
                thresholdModal = new bootstrap.Modal(el);
            }
            const elVol = document.getElementById('volumeLimitModal');
            if (elVol) {
                volumeLimitModal = new bootstrap.Modal(elVol);
            }
            const elTest = document.getElementById('testConfigModal');
            if (elTest) {
                testConfigModal = new bootstrap.Modal(elTest);
            }
            const elRepeat = document.getElementById('repeatMonitorConfigModal');
            if (elRepeat) {
                repeatMonitorConfigModal = new bootstrap.Modal(elRepeat);
            }
            const elOrderCancel = document.getElementById('orderCancelMonitorConfigModal');
            if (elOrderCancel) {
                orderCancelMonitorConfigModal = new bootstrap.Modal(elOrderCancel);
            }
        });

        let lastToastKey = '';
        let lastToastAt = 0;

        function showToast(title, message, variant) {
            const toastId = `toast-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            let variantClass = '';
            let iconSvg = '';
            
            if (variant === 'danger') {
                variantClass = 'apple-toast-danger';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
            } else if (variant === 'success') {
                variantClass = 'apple-toast-success';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-success" style="color: #30d158;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
            } else {
                // warning or default
                variantClass = 'apple-toast-warning';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
            }

            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div id="${toastId}" class="toast apple-toast ${variantClass}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true">
                    <div class="d-flex align-items-start p-3">
                        <div class="me-3 mt-1">${iconSvg}</div>
                        <div class="w-100">
                            <div class="apple-toast-title mb-1">${title}</div>
                            <div class="apple-toast-message">${message}</div>
                        </div>
                        <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            const toastEl = wrapper.firstElementChild;
            toastContainer.appendChild(toastEl);
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 6000 });
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            toast.show();
        }

        function safeInt(value) {
            const n = Number.parseInt(String(value), 10);
            if (!Number.isFinite(n) || n <= 0) return null;
            return n;
        }

        function setFormFromThresholds(thr) {
            if (!thr) return;
            const o = safeInt(thr.max_order_count);
            const c = safeInt(thr.max_cancel_count);
            const r = safeInt(thr.max_repeat_count);
            if (o) thresholdInputs.order.value = o;
            if (c) thresholdInputs.cancel.value = c;
            if (r) thresholdInputs.repeat.value = r;
            thresholdInputs.repeatEnabled.checked = (Number(thr.max_repeat_count || 0) > 0);
        }

        function updateSnapshot(risk) {
            const thresholds = (risk && risk.thresholds) ? risk.thresholds : null;
            const metric = (risk && risk.metrics) ? risk.metrics : null;

            if (thresholds) {
                thresholdCurrent.order.textContent = thresholds.max_order_count ?? '-';
                thresholdCurrent.cancel.textContent = thresholds.max_cancel_count ?? '-';
                thresholdCurrent.repeat.textContent = thresholds.max_repeat_count ?? '-';
            }
            if (metric) {
                metrics.order.textContent = metric.order_count ?? '-';
                metrics.cancel.textContent = metric.cancel_count ?? '-';
                metrics.repeat.textContent = metric.repeat_total ?? '-';
            }
        }

        function loadThresholdsFromServer() {
            return fetch('/api/risk/thresholds', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '读取阈值失败');
                    const thr = data.data || {};
                    setFormFromThresholds(thr);
                    thresholdCurrent.order.textContent = thr.max_order_count ?? '-';
                    thresholdCurrent.cancel.textContent = thr.max_cancel_count ?? '-';
                    thresholdCurrent.repeat.textContent = thr.max_repeat_count ?? '-';
                    return thr;
                })
                .catch(err => {
                    showToast('读取阈值失败', String(err), 'danger');
                });
        }

        function loadSnapshot() {
            return fetch('/api/risk/snapshot', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '读取统计失败');
                    updateSnapshot(data.data || {});
                })
                .catch(() => {});
        }

        function applyThresholds() {
            const maxOrder = safeInt(thresholdInputs.order.value);
            const maxCancel = safeInt(thresholdInputs.cancel.value);
            const repeatEnabled = Boolean(thresholdInputs.repeatEnabled.checked);
            const maxRepeat = repeatEnabled ? safeInt(thresholdInputs.repeat.value) : 0;

            if (!maxOrder || !maxCancel || (repeatEnabled && !maxRepeat)) {
                showToast('参数错误', '请填写有效的阈值(正整数)', 'danger');
                return Promise.resolve(false);
            }

            const payload = { max_order_count: maxOrder, max_cancel_count: maxCancel, max_repeat_count: maxRepeat };
            localStorage.setItem('risk_thresholds', JSON.stringify(payload));

            return fetch('/api/risk/thresholds', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '阈值设置失败');
                    const risk = data.data || {};
                    updateSnapshot(risk);
                    showToast('阈值已更新', `报单=${maxOrder}, 撤单=${maxCancel}, 重复报单=${maxRepeat}`, 'warning');
                    return true;
                })
                .catch(err => {
                    showToast('阈值设置失败', String(err), 'danger');
                    return false;
                });
        }

        function openThresholdModal() {
            if (thresholdModal) {
                loadThresholdsFromServer().then(() => {
                    thresholdModal.show();
                });
            }
        }

        function saveThresholds() {
            applyThresholds().then((success) => {
                if (success) {
                    if (thresholdModal) thresholdModal.hide();
                }
            });
        }

        function loadTestConfigFromServer() {
            return fetch('/api/test/config', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '读取配置失败');
                    const conf = data.data || {};
                    if (conf.test_symbol) testConfigInputs.symbol.value = conf.test_symbol;
                    if (conf.safe_buy_price) testConfigInputs.safePrice.value = conf.safe_buy_price;
                    if (conf.deal_buy_price) testConfigInputs.dealPrice.value = conf.deal_buy_price;
                    return conf;
                })
                .catch(err => {
                    showToast('读取配置失败', String(err), 'danger');
                });
        }

        function openTestConfigModal() {
            if (testConfigModal) {
                loadTestConfigFromServer().then(() => {
                    testConfigModal.show();
                });
            }
        }

        function saveTestConfig() {
            const symbol = testConfigInputs.symbol.value.trim();
            const safePrice = parseFloat(testConfigInputs.safePrice.value);
            const dealPrice = parseFloat(testConfigInputs.dealPrice.value);

            if (!symbol || isNaN(safePrice) || isNaN(dealPrice)) {
                showToast('参数错误', '请填写有效的参数', 'danger');
                return;
            }

            const payload = { 
                test_symbol: symbol, 
                safe_buy_price: safePrice, 
                deal_buy_price: dealPrice 
            };

            fetch('/api/test/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '配置保存失败');
                    showToast('配置已更新', `合约=${symbol}, 价格=${safePrice}/${dealPrice}`, 'warning');
                    if (testConfigModal) testConfigModal.hide();
                })
                .catch(err => {
                    showToast('配置保存失败', String(err), 'danger');
                });
        }

        function saveAndRunTestConfig() {
            saveTestConfig();
        }

        function loadRepeatMonitorConfigFromServer() {
            return fetch('/api/test/config', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '读取配置失败');
                    const conf = data.data || {};
                    if (conf.repeat_open_threshold) repeatMonitorConfigInputs.openThreshold.value = conf.repeat_open_threshold;
                    if (conf.repeat_close_threshold) repeatMonitorConfigInputs.closeThreshold.value = conf.repeat_close_threshold;
                    if (conf.test_symbol) repeatMonitorConfigInputs.symbol.value = conf.test_symbol;
                    if (conf.safe_buy_price) repeatMonitorConfigInputs.safePrice.value = conf.safe_buy_price;
                    if (conf.deal_buy_price) repeatMonitorConfigInputs.dealPrice.value = conf.deal_buy_price;
                    return conf;
                })
                .catch(err => {
                    showToast('读取配置失败', String(err), 'danger');
                });
        }

        function openRepeatMonitorConfigModal() {
            if (repeatMonitorConfigModal) {
                loadRepeatMonitorConfigFromServer().then(() => {
                    repeatMonitorConfigModal.show();
                });
            }
        }

        function saveRepeatMonitorConfig() {
            const openThr = safeInt(repeatMonitorConfigInputs.openThreshold.value);
            const closeThr = safeInt(repeatMonitorConfigInputs.closeThreshold.value);
            const symbol = repeatMonitorConfigInputs.symbol.value.trim();
            const safePrice = parseFloat(repeatMonitorConfigInputs.safePrice.value);
            const dealPrice = parseFloat(repeatMonitorConfigInputs.dealPrice.value);

            if (!openThr || !closeThr || !symbol || isNaN(safePrice) || isNaN(dealPrice)) {
                showToast('参数错误', '请填写有效的参数', 'danger');
                return;
            }

            const payload = {
                repeat_open_threshold: openThr,
                repeat_close_threshold: closeThr,
                test_symbol: symbol,
                safe_buy_price: safePrice,
                deal_buy_price: dealPrice,
            };

            fetch('/api/test/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '配置保存失败');
                    showToast('配置已更新', `阈值=${openThr}/${closeThr}, 合约=${symbol}, 价格=${safePrice}/${dealPrice}`, 'warning');
                    if (repeatMonitorConfigModal) repeatMonitorConfigModal.hide();
                })
                .catch(err => {
                    showToast('配置保存失败', String(err), 'danger');
                });
        }

        function loadOrderCancelMonitorConfigFromServer() {
            return fetch('/api/test/config', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '读取配置失败');
                    const conf = data.data || {};
                    if (conf.order_monitor_threshold) orderCancelMonitorConfigInputs.orderThreshold.value = conf.order_monitor_threshold;
                    if (conf.cancel_monitor_threshold) orderCancelMonitorConfigInputs.cancelThreshold.value = conf.cancel_monitor_threshold;
                    return conf;
                })
                .catch(err => {
                    showToast('读取配置失败', String(err), 'danger');
                });
        }

        function openOrderCancelMonitorConfigModal() {
            if (orderCancelMonitorConfigModal) {
                loadOrderCancelMonitorConfigFromServer().then(() => {
                    if (!orderCancelMonitorConfigInputs.orderThreshold.value) orderCancelMonitorConfigInputs.orderThreshold.value = 1;
                    if (!orderCancelMonitorConfigInputs.cancelThreshold.value) orderCancelMonitorConfigInputs.cancelThreshold.value = 1;
                    orderCancelMonitorConfigModal.show();
                });
            }
        }

        function saveOrderCancelMonitorConfig() {
            const orderThr = safeInt(orderCancelMonitorConfigInputs.orderThreshold.value);
            const cancelThr = safeInt(orderCancelMonitorConfigInputs.cancelThreshold.value);

            if (!orderThr || !cancelThr) {
                showToast('参数错误', '请填写有效的阈值(正整数)', 'danger');
                return;
            }

            const payload = { order_monitor_threshold: orderThr, cancel_monitor_threshold: cancelThr };
            fetch('/api/test/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '配置保存失败');
                    showToast('配置已更新', `报单监测阈值=${orderThr}, 撤单监测阈值=${cancelThr}`, 'warning');
                    if (orderCancelMonitorConfigModal) orderCancelMonitorConfigModal.hide();
                })
                .catch(err => {
                    showToast('配置保存失败', String(err), 'danger');
                });
        }

        function loadVolumeLimitConfigFromServer() {
            return fetch('/api/test/config', { method: 'GET' })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '读取配置失败');
                    const conf = data.data || {};
                    if (conf.test_symbol) volumeLimitInputs.symbol.value = conf.test_symbol;
                    if (conf.volume_limit_volume) volumeLimitInputs.volume.value = conf.volume_limit_volume;
                    return conf;
                })
                .catch(err => {
                    showToast('读取配置失败', String(err), 'danger');
                });
        }

        function openVolumeLimitModal() {
            if (volumeLimitModal) {
                loadVolumeLimitConfigFromServer().then(() => {
                    if (!volumeLimitInputs.volume.value) volumeLimitInputs.volume.value = 10000;
                    volumeLimitModal.show();
                });
            }
        }

        function saveAndRunVolumeLimit() {
            const symbol = volumeLimitInputs.symbol.value.trim();
            const volume = safeInt(volumeLimitInputs.volume.value);

            if (!symbol || !volume) {
                showToast('参数错误', '请填写有效的品种与手数(正整数)', 'danger');
                return;
            }

            const payload = { test_symbol: symbol, volume_limit_volume: volume };
            fetch('/api/test/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') throw new Error(data.msg || '配置保存失败');
                    showToast('配置已更新', `合约=${symbol}, 手数=${volume}`, 'warning');
                    if (volumeLimitModal) volumeLimitModal.hide();
                    runTest('2.4.1.3');
                })
                .catch(err => {
                    showToast('配置保存失败', String(err), 'danger');
                });
        }

        // 日志接收逻辑
        socket.on('new_log', function(data) {
            // 智能滚动判定：在插入内容前，检查是否接近底部 (允许 50px 误差)
            const isAtBottom = logContainer.scrollHeight - logContainer.scrollTop - logContainer.clientHeight < 50;

            const div = document.createElement('div');
            div.className = 'log-line';
            div.style.color = data.color;
            div.textContent = data.message;
            
            logContainer.appendChild(div);
            
            // 如果之前在底部，则保持跟随最新日志
            if (isAtBottom) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            // 性能优化：限制最大行数 1000
            if (logContainer.children.length > 1000) {
                logContainer.removeChild(logContainer.firstChild);
            }

            const msg = String(data.message || '');
            
            let alertType = null;
            let alertTitle = '';

            if (msg.includes('【阈值预警】') || msg.includes('【风控预警】')) {
                alertType = msg.includes('【风控拦截】') ? 'danger' : 'warning';
                alertTitle = '预警';
            } else if (msg.includes('资金不足')) {
                alertType = 'warning';
                alertTitle = '资金告警';
            } else if (msg.includes('交易服务器连接成功') || msg.includes('行情服务器连接成功')) {
                alertType = 'success';
                alertTitle = '连接恢复';
            } else if (msg.includes('交易服务器连接断开') || msg.includes('行情服务器连接断开')) {
                alertType = 'danger';
                alertTitle = '连接断开';
            }

            if (alertType) {
                const now = Date.now();
                const key = msg.slice(0, 200);
                if (!(key === lastToastKey && (now - lastToastAt) < 3000)) {
                    lastToastKey = key;
                    lastToastAt = now;
                    showToast(alertTitle, msg, alertType);
                }
            }
        });

        socket.on('connect', () => {
            logContainer.innerHTML = '<div class="text-success p-2">✅ 服务器已连接</div>';
            loadThresholdsFromServer();
            loadSnapshot();

            try {
                const stored = JSON.parse(localStorage.getItem('risk_thresholds') || 'null');
                if (stored && typeof stored === 'object') {
                    setFormFromThresholds(stored);
                }
            } catch (e) {}
        });

        socket.on('worker_status', (data) => {
            if (data && data.risk) {
                updateSnapshot(data.risk);
            }
        });

        // API 调用逻辑
        function runTest(caseId) {
            fetch(`/api/run/${caseId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.status !== 'success') alert(data.msg);
                });
        }

        function resetSystem() {
            fetch('/api/control/reset', { method: 'POST' })
                .then(res => res.json())
                .then(data => alert(data.msg));
        }
    </script>
</body>
</html>
